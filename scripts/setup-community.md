# 社区功能设置指南

本指南将帮助您设置Procreate笔刷网站的社区论坛功能。

## 设置数据库表和结构

1. 登录到您的Supabase项目管理面板
2. 点击左侧导航栏中的"SQL编辑器"
3. 点击"新查询"按钮
4. 打开本地项目中的 `scripts/create_topics_table.sql` 文件，复制其内容
5. 粘贴到Supabase SQL编辑器窗口中
6. 点击"运行"按钮执行SQL脚本

这将创建以下内容：

- `topics` 表 - 存储所有社区讨论主题
- `topic_replies` 表 - 存储主题回复
- 行级安全策略 - 确保数据访问安全
- 触发器 - 自动更新回复计数和浏览量

## 常见问题解决

### 错误：42P07：关系"主题"已存在

如果遇到这个错误，说明`topics`表已经存在于数据库中。我们的脚本使用了`IF NOT EXISTS`条件，所以正常情况下不应该出现此错误。如果仍然出现，可以尝试以下解决方法：

1. 在SQL编辑器中运行以下命令查看表是否真的存在：
   ```sql
   SELECT * FROM information_schema.tables 
   WHERE table_schema = 'public' AND table_name = 'topics';
   ```

2. 如果表确实存在但结构不正确，可以先删除它：
   ```sql
   DROP TABLE IF EXISTS topics CASCADE;
   ```
   然后再运行 `create_topics_table.sql` 脚本

### 刷新后主题不见了

这个问题通常有以下几个原因：

1. **前端从本地存储读取数据** - 我们已经修复了前端代码，使其正确从数据库加载数据
2. **没有正确保存到数据库** - 检查数据库连接和行级安全策略
3. **数据库权限问题** - 确保当前用户有权访问topics表

我们已经更新了前端代码的以下部分：

1. 添加`refreshTrigger`状态以在创建、编辑或删除主题后刷新数据
2. 优化`fetchTopics`函数以更好地处理数据获取错误
3. 简化数据库访问逻辑，直接尝试读取数据

## 测试步骤

在设置完成后，请按照以下步骤测试：

1. 登录网站（必须登录才能创建主题）
2. 前往社区页面
3. 创建一个新主题
4. 刷新页面，确认主题仍然显示
5. 编辑或删除主题，确认更改在刷新后仍然保持

如果按照上述步骤操作后仍有问题，请查看浏览器控制台中的错误信息，这可能提供更多有关问题的线索。 